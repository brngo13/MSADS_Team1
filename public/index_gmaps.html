<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facility Risk Mapper</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Archivo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Google Maps specific overrides */
        #map {
            height: 100vh;
            width: 100%;
        }

        /* Ensure control panel appears above map */
        .control-panel {
            z-index: 1000;
        }

        .legend {
            z-index: 1000;
        }

        /* Custom marker styles */
        .custom-marker {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .custom-marker:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="control-panel">
        <div class="panel-header">
            <div class="panel-title">Facility Risk Mapper</div>
            <div class="panel-subtitle">EPA emission facilities with environmental justice risk assessment</div>
        </div>

        <!-- Single tab for facility data -->
        <div class="tab-content active">
            <div class="panel-section">
                <div class="section-label">Facility Data</div>
                <div style="font-size: 13px; color: var(--text-primary);">
                    <div style="margin-bottom: 8px;">
                        <strong>Total Facilities:</strong> <span id="facility-count">0</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong>Year:</strong> <span id="data-year">2021</span>
                    </div>
                    <div>
                        <strong>Risk Metric:</strong> Risk Index
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-label">Risk Level Filter</div>
                <select id="risk-filter" class="year-selector">
                    <option value="">All Risk Levels</option>
                    <option value="High">High Risk Only</option>
                    <option value="Medium">Medium Risk Only</option>
                    <option value="Low">Low Risk Only</option>
                </select>
            </div>

            <div class="panel-section">
                <div class="section-label">Total Emissions Filter</div>
                <div style="margin-bottom: 8px; font-size: 13px; color: var(--text-primary);">
                    Minimum: <span id="emissions-value">1k</span> tons/year
                </div>
                <input
                    type="range"
                    id="emissions-slider"
                    min="0"
                    max="5"
                    step="0.1"
                    value="3"
                    style="width: 100%; margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-bottom: 12px;">
                    <span>1 ton</span>
                    <span>100k tons</span>
                </div>
                <button id="apply-filters" class="btn-primary">Apply Filters</button>
            </div>

            <div class="panel-section">
                <div class="section-label">Social Data</div>

                <!-- Year Selection -->
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Year</label>
                    <select id="social-year-selector" class="year-selector">
                        <option value="">Select Year</option>
                        <option value="2015">2015</option>
                        <option value="2016" disabled>2016</option>
                        <option value="2017" disabled>2017</option>
                        <option value="2018" disabled>2018</option>
                        <option value="2019" disabled>2019</option>
                        <option value="2020">2020</option>
                        <option value="2021" disabled>2021</option>
                        <option value="2022" disabled>2022</option>
                        <option value="2023">2023</option>
                        <option value="2024" disabled>2024</option>
                        <option value="2025" disabled>2025</option>
                    </select>
                </div>

                <!-- Indicator Selection -->
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Socioeconomic Indicator</label>
                    <select id="social-indicator-selector" class="year-selector">
                        <option value="">Select Indicator</option>
                        <option value="adi">Area Deprivation Index (ADI)</option>
                    </select>
                </div>

                <!-- ADI Rank Type Selection -->
                <div id="adi-rank-type-section" style="margin-bottom: 12px; display: none;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">ADI Rank Type</label>
                    <select id="adi-rank-type-selector" class="year-selector">
                        <option value="national">National Rank (1-100)</option>
                        <option value="state">State Rank (1-10)</option>
                    </select>
                </div>

                <!-- Census Boundary Type -->
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 8px;">Census Boundaries (2010 - Testing)</label>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="census-boundary" value="none" checked>
                            <span style="font-size: 13px; color: var(--text-primary);">None</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="census-boundary" value="tract">
                            <span style="font-size: 13px; color: var(--text-primary);">Census Tract (2010)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="census-boundary" value="block">
                            <span style="font-size: 13px; color: var(--text-primary);">Census Block Group (2010)</span>
                        </label>
                    </div>
                    <div style="margin-top: 8px; font-size: 10px; color: var(--text-secondary); font-style: italic;">
                        Using 2010 census geographies to match ADI data
                    </div>
                </div>

                <!-- Load Button -->
                <button id="load-social-data" class="btn-primary">Display Social Data</button>

                <!-- Status -->
                <div id="social-data-status" style="margin-top: 12px; font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
                    <p>Select year and indicator to display choropleth</p>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-label">Info</div>
                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
                    <p style="margin-bottom: 8px;">Click markers to view facility details including:</p>
                    <ul style="margin-left: 16px; margin-top: 8px;">
                        <li>Site name and facility ID</li>
                        <li>Total emissions (tons/year)</li>
                        <li>NAICS code and description</li>
                    </ul>
                    <p style="margin-top: 12px; font-size: 11px;">
                        Circle color indicates risk level, size indicates total emissions.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="legend" id="map-legend">
        <!-- Facility Risk Legend (default) -->
        <div id="facility-legend">
            <div class="legend-title">Facility Risk Level</div>
            <div class="legend-item">
                <div class="legend-circle" style="background: #ef4444;"></div>
                <div class="legend-text">High Risk</div>
            </div>
            <div class="legend-item">
                <div class="legend-circle amber"></div>
                <div class="legend-text">Medium Risk</div>
            </div>
            <div class="legend-item">
                <div class="legend-circle green"></div>
                <div class="legend-text">Low Risk</div>
            </div>
            <div class="legend-item" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
                <div class="legend-text" style="font-size: 11px; color: var(--text-secondary);">
                    Circle size = Total Emissions
                </div>
            </div>
        </div>

        <!-- ADI Legend (hidden by default) -->
        <div id="adi-legend" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
            <div class="legend-title">Area Deprivation Index</div>
            <div class="legend-item">
                <div style="width: 16px; height: 16px; background: #e5e7eb; border-radius: 2px;"></div>
                <div class="legend-text">Low Disadvantage (1-20)</div>
            </div>
            <div class="legend-item">
                <div style="width: 16px; height: 16px; background: #cbd5e1; border-radius: 2px;"></div>
                <div class="legend-text">Below Average (21-40)</div>
            </div>
            <div class="legend-item">
                <div style="width: 16px; height: 16px; background: #94a3b8; border-radius: 2px;"></div>
                <div class="legend-text">Average (41-60)</div>
            </div>
            <div class="legend-item">
                <div style="width: 16px; height: 16px; background: #64748b; border-radius: 2px;"></div>
                <div class="legend-text">Above Average (61-80)</div>
            </div>
            <div class="legend-item">
                <div style="width: 16px; height: 16px; background: #475569; border-radius: 2px;"></div>
                <div class="legend-text">High Disadvantage (81-100)</div>
            </div>
        </div>

        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
            <button id="theme-toggle" class="btn-secondary" style="width: 100%; font-size: 11px; padding: 8px;">
                ðŸŒ™ Light Mode
            </button>
        </div>
    </div>

    <!-- Facility Details Modal -->
    <div id="facility-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="modal-title">Facility Details</div>
                <button id="facility-modal-close" style="background: none; border: none; color: var(--text-secondary);
                        font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
            </div>
            <div id="facility-details-content" style="font-family: 'IBM Plex Mono', monospace; font-size: 13px;">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Load PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Load MarkerClusterer for clustering markers -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

    <!-- Load configuration and Google Maps API dynamically -->
    <script>
        // Fetch config and load Google Maps API
        fetch('/api/config')
            .then(response => response.json())
            .then(config => {
                // Store config globally
                window.APP_CONFIG = config;

                // Dynamically load Google Maps API with key from config
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${config.googleMapsApiKey}&callback=initMap`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            })
            .catch(error => {
                console.error('Failed to load configuration:', error);
                alert('Failed to load app configuration. Please ensure config.json exists.');
            });
    </script>

    <script src="app_gmaps.js"></script>
</body>
</html>
